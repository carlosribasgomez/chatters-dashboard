<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chatters Dashboard - Centro de Control Team Leaders</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg-primary: #0f1117;
      --bg-secondary: #1a1d2e;
      --bg-card: #1e2235;
      --bg-hover: #252a40;
      --accent-blue: #4f8cff;
      --accent-green: #34d399;
      --accent-yellow: #fbbf24;
      --accent-red: #f87171;
      --accent-purple: #a78bfa;
      --accent-orange: #fb923c;
      --accent-pink: #f472b6;
      --accent-cyan: #22d3ee;
      --text-primary: #e8eaed;
      --text-secondary: #9ca3af;
      --text-muted: #6b7280;
      --border: #2d3348;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; }
    .header { background: linear-gradient(135deg, #1a1d2e, #252a40); border-bottom: 1px solid var(--border); padding: 16px 32px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
    .header h1 { font-size: 20px; font-weight: 700; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .header .subtitle { color: var(--text-secondary); font-size: 12px; }
    .badge { background: var(--bg-card); border: 1px solid var(--border); padding: 4px 12px; border-radius: 16px; font-size: 11px; color: var(--text-secondary); }
    .container { max-width: 1600px; margin: 0 auto; padding: 20px 28px; }

    /* Nav */
    .nav-tabs { display: flex; gap: 4px; background: var(--bg-secondary); border-radius: 12px; padding: 4px; margin-bottom: 20px; overflow: visible; align-items: center; }
    .nav-tab { padding: 9px 18px; border-radius: 8px; border: none; background: transparent; color: var(--text-secondary); font-size: 13px; font-weight: 500; cursor: pointer; transition: all .2s; white-space: nowrap; }
    .nav-tab:hover { background: var(--bg-hover); color: var(--text-primary); }
    .nav-tab.active { background: var(--accent-blue); color: #fff; }
    .dropdown { position: relative; display: inline-block; }
    .dropdown-btn { padding: 9px 18px; border-radius: 8px; border: none; background: transparent; color: var(--text-secondary); font-size: 13px; font-weight: 500; cursor: pointer; white-space: nowrap; }
    .dropdown-btn:hover, .dropdown-btn.active { background: var(--accent-blue); color: #fff; }
    .dropdown-menu { display: none; position: absolute; top: 100%; left: 0; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; min-width: 200px; z-index: 50; margin-top: 4px; overflow: hidden; }
    .dropdown.open .dropdown-menu { display: block; }
    .dropdown-item { padding: 10px 16px; font-size: 13px; cursor: pointer; color: var(--text-secondary); transition: all .15s; border: none; background: none; width: 100%; text-align: left; }
    .dropdown-item:hover { background: var(--bg-hover); color: var(--text-primary); }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* KPI Cards */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 14px; margin-bottom: 20px; }
    .kpi-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; transition: transform .2s; }
    .kpi-card:hover { transform: translateY(-2px); border-color: var(--accent-blue); }
    .kpi-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 6px; }
    .kpi-value { font-size: 24px; font-weight: 700; }
    .kpi-value.blue { color: var(--accent-blue); }
    .kpi-value.green { color: var(--accent-green); }
    .kpi-value.yellow { color: var(--accent-yellow); }
    .kpi-value.red { color: var(--accent-red); }
    .kpi-value.purple { color: var(--accent-purple); }
    .kpi-value.orange { color: var(--accent-orange); }
    .kpi-value.pink { color: var(--accent-pink); }
    .kpi-value.cyan { color: var(--accent-cyan); }
    .kpi-detail { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }

    /* Charts */
    .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
    .chart-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
    .chart-card.full { grid-column: 1 / -1; }
    .chart-title { font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .dot.blue { background: var(--accent-blue); } .dot.green { background: var(--accent-green); }
    .dot.yellow { background: var(--accent-yellow); } .dot.purple { background: var(--accent-purple); }
    .dot.red { background: var(--accent-red); } .dot.cyan { background: var(--accent-cyan); }
    .chart-container { position: relative; height: 280px; }
    .chart-container.sm { height: 200px; }

    /* Tables */
    .table-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
    .table-header { padding: 14px 18px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
    .table-header h3 { font-size: 15px; font-weight: 600; }
    .search-input { background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; padding: 7px 12px; color: var(--text-primary); font-size: 12px; outline: none; width: 220px; }
    .search-input:focus { border-color: var(--accent-blue); }
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th { background: var(--bg-secondary); padding: 10px 14px; text-align: left; font-size: 10px; text-transform: uppercase; letter-spacing: .5px; color: var(--text-muted); font-weight: 600; cursor: pointer; user-select: none; white-space: nowrap; position: sticky; top: 0; }
    .data-table th:hover { color: var(--text-primary); }
    .data-table th.sorted { color: var(--accent-blue); }
    .data-table td { padding: 10px 14px; font-size: 12px; border-bottom: 1px solid var(--border); white-space: nowrap; }
    .data-table tr:hover td { background: var(--bg-hover); }
    .data-table .num { text-align: right; font-variant-numeric: tabular-nums; }
    .clickable { cursor: pointer; color: var(--accent-blue); text-decoration: none; }
    .clickable:hover { text-decoration: underline; }
    .table-scroll { overflow-x: auto; max-height: 600px; overflow-y: auto; }

    .pill { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; }
    .pill.good { background: rgba(16,185,129,.15); color: var(--accent-green); }
    .pill.warn { background: rgba(251,191,36,.15); color: var(--accent-yellow); }
    .pill.bad { background: rgba(248,113,113,.15); color: var(--accent-red); }
    .progress-bar { background: var(--bg-primary); border-radius: 4px; height: 5px; width: 80px; display: inline-block; vertical-align: middle; margin-left: 6px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 4px; }

    .peak-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 14px; margin-bottom: 20px; }
    .peak-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 14px; }
    .peak-icon { width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
    .peak-icon.traffic { background: rgba(79,140,255,.15); }
    .peak-icon.sales { background: rgba(52,211,153,.15); }
    .peak-icon.speed { background: rgba(251,191,36,.15); }
    .peak-icon.fans { background: rgba(167,139,250,.15); }
    .peak-info h4 { font-size: 12px; color: var(--text-secondary); font-weight: 500; }
    .peak-info .pv { font-size: 22px; font-weight: 700; }
    .peak-info .pd { font-size: 11px; color: var(--text-muted); }

    .section-title { font-size: 16px; font-weight: 700; margin-bottom: 14px; display: flex; align-items: center; gap: 10px; }
    .count { background: var(--bg-card); border: 1px solid var(--border); padding: 2px 10px; border-radius: 12px; font-size: 11px; color: var(--text-secondary); font-weight: 500; }

    /* Modal */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.7); z-index: 200; backdrop-filter: blur(4px); align-items: center; justify-content: center; }
    .modal-overlay.active { display: flex; }
    .modal { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; width: 95%; max-width: 1200px; max-height: 90vh; overflow-y: auto; padding: 24px; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .modal-header h2 { font-size: 18px; font-weight: 700; }
    .modal-close { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-secondary); font-size: 16px; }
    .modal-close:hover { background: var(--accent-red); color: #fff; }

    .rank { display: inline-flex; align-items: center; justify-content: center; width: 22px; height: 22px; border-radius: 5px; font-size: 10px; font-weight: 700; margin-right: 6px; }
    .rank.gold { background: rgba(251,191,36,.2); color: var(--accent-yellow); }
    .rank.silver { background: rgba(156,163,175,.2); color: #c0c0c0; }
    .rank.bronze { background: rgba(251,146,60,.2); color: var(--accent-orange); }
    .rank.n { background: var(--bg-primary); color: var(--text-muted); }

    .sub-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-bottom: 14px; }
    .sub-section h4 { font-size: 13px; font-weight: 600; margin-bottom: 10px; color: var(--text-secondary); }

    /* Filter Bar */
    .filter-bar { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
    .filter-dropdown { position: relative; display: inline-block; }
    .filter-btn { padding: 7px 14px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-secondary); font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px; white-space: nowrap; }
    .filter-btn:hover { border-color: var(--accent-blue); color: var(--text-primary); }
    .filter-btn.has-filter { border-color: var(--accent-blue); color: var(--accent-blue); background: rgba(79,140,255,.1); }
    .filter-panel { display: none; position: absolute; top: 100%; left: 0; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; min-width: 260px; z-index: 60; margin-top: 4px; box-shadow: 0 8px 32px rgba(0,0,0,.4); max-height: 400px; overflow: hidden; }
    .filter-panel.open { display: flex; flex-direction: column; }
    .filter-panel-header { padding: 10px 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .filter-panel-header h4 { font-size: 12px; color: var(--text-secondary); }
    .filter-panel-body { overflow-y: auto; max-height: 320px; padding: 6px 0; }
    .filter-option { padding: 7px 12px; font-size: 12px; cursor: pointer; color: var(--text-secondary); display: flex; align-items: center; gap: 8px; transition: all .12s; }
    .filter-option:hover { background: var(--bg-hover); color: var(--text-primary); }
    .filter-option.active { color: var(--accent-blue); }
    .filter-option input[type=checkbox] { accent-color: var(--accent-blue); width: 14px; height: 14px; cursor: pointer; }
    .filter-search { width: 100%; padding: 7px 10px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 11px; outline: none; }
    .filter-search:focus { border-color: var(--accent-blue); }
    .filter-quick-btns { display: flex; gap: 4px; flex-wrap: wrap; padding: 6px 12px; border-bottom: 1px solid var(--border); }
    .filter-quick-btn { padding: 3px 8px; border-radius: 4px; border: 1px solid var(--border); background: transparent; color: var(--text-muted); font-size: 10px; cursor: pointer; }
    .filter-quick-btn:hover { border-color: var(--accent-blue); color: var(--text-primary); }
    .filter-quick-btn.active { background: var(--accent-blue); color: #fff; border-color: var(--accent-blue); }
    .date-custom-row { display: flex; gap: 6px; padding: 8px 12px; border-top: 1px solid var(--border); }
    .date-custom-row input { flex: 1; padding: 5px 8px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 5px; color: var(--text-primary); font-size: 11px; }
    .filter-active-label { font-size: 10px; color: var(--accent-blue); margin-left: 4px; font-weight: 600; }

    @media (max-width: 768px) {
      .container { padding: 12px; }
      .charts-grid { grid-template-columns: 1fr; }
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
      .header { padding: 12px; flex-direction: column; gap: 6px; }
    }
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h1>Chatters Dashboard</h1>
      <div class="subtitle">Centro de Control - Team Leaders | Chatting Wizard ESP</div>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <span class="badge" id="reportDate"></span>
      <span class="badge" id="reportGen"></span>
    </div>
  </div>

  <div class="container">
    <div class="nav-tabs" id="navTabs">
      <button class="nav-tab active" onclick="switchTab('general',this)">General</button>
      <div class="dropdown" id="shiftDropdown">
        <button class="dropdown-btn" onclick="toggleDropdown(event)">Por Turno &#9662;</button>
        <div class="dropdown-menu">
          <button class="dropdown-item" onclick="switchTab('turno1',this)">12:00 AM - 8:00 AM</button>
          <button class="dropdown-item" onclick="switchTab('turno2',this)">8:00 AM - 4:00 PM</button>
          <button class="dropdown-item" onclick="switchTab('turno3',this)">4:00 PM - 11:59 PM</button>
        </div>
      </div>
      <button class="nav-tab" onclick="switchTab('models',this)">Por Modelo</button>
      <button class="nav-tab" onclick="switchTab('chatters',this)">Por Chatter</button>
      <button class="nav-tab" onclick="switchTab('hourly',this)">Por Horas</button>
    </div>

    <div id="tab-general" class="tab-content active"></div>
    <div id="tab-turno1" class="tab-content"></div>
    <div id="tab-turno2" class="tab-content"></div>
    <div id="tab-turno3" class="tab-content"></div>
    <div id="tab-models" class="tab-content"></div>
    <div id="tab-chatters" class="tab-content"></div>
    <div id="tab-hourly" class="tab-content"></div>
  </div>

  <div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
    <div class="modal" id="modalContent"></div>
  </div>

<script>
let D = null;
const CI = {};
let dateFilter = 'all'; // 'all','today','yesterday','last7','last30','last90','last365','thisMonth','lastMonth','custom'
let dateCustomStart = null, dateCustomEnd = null;
let selectedModels = []; // empty = all models

async function loadData() {
  try {
    const r = await fetch('dashboard_data.json');
    D = await r.json();
  } catch(e) {
    D = window.__EMBEDDED_DATA__;
  }
  if (!D) {
    document.querySelector('.container').innerHTML = '<div style="padding:40px;text-align:center;color:var(--accent-red)">Error cargando datos</div>';
    return;
  }
  render();
}

function $(id) { return document.getElementById(id); }
function cc(id, cfg) { if(CI[id]) CI[id].destroy(); const c=document.getElementById(id); if(!c) return; CI[id]=new Chart(c,cfg); }

function render() {
  $('reportDate').textContent = 'Reporte: ' + D.report_date;
  $('reportGen').textContent = 'Generado: ' + D.generated_at;
  // Ensure daily_hourly & daily_model exist (backward compat)
  if(!D.daily_hourly) D.daily_hourly=[];
  if(!D.daily_model) D.daily_model=[];
  renderGeneral();
  renderShifts();
  renderModels();
  renderChatters();
  renderHourly();
}

// =============== HELPERS ===============
function rb(i) {
  if(i===0) return '<span class="rank gold">1</span>';
  if(i===1) return '<span class="rank silver">2</span>';
  if(i===2) return '<span class="rank bronze">3</span>';
  return '<span class="rank n">'+(i+1)+'</span>';
}
// Golden Ratio: 0-2.99 desastre | 3-4.99 flojo | 5-6.99 bien | 7-8.99 muy bien | 9+ agresivo
function grPill(v) {
  if(v>=9) return '<span class="pill" style="background:rgba(79,140,255,.2);color:var(--accent-blue)">'+v+'%</span>';
  if(v>=7) return '<span class="pill good">'+v+'%</span>';
  if(v>=5) return '<span class="pill" style="background:rgba(52,211,153,.12);color:#6ee7b7">'+v+'%</span>';
  if(v>=3) return '<span class="pill warn">'+v+'%</span>';
  return '<span class="pill bad">'+v+'%</span>';
}
function grLabel(v) {
  if(v>=9) return 'Agresivo';
  if(v>=7) return 'Muy Bien';
  if(v>=5) return 'Bien';
  if(v>=3) return 'Flojo';
  return 'Desastre';
}
function urPill(v) { return '<span class="pill '+(v>=30?'good':v>=20?'warn':'bad')+'">'+v+'%</span>'; }
// Reply Time: 0-90s muy bueno | 90-120s bueno | 120-150s medio | 150-180s malo | 180s+ muy malo
function rtPill(s) {
  if(!s) return '<span class="pill warn">N/A</span>';
  if(s<=90) return '<span class="pill good">Muy Rapido</span>';
  if(s<=120) return '<span class="pill" style="background:rgba(52,211,153,.12);color:#6ee7b7">Rapido</span>';
  if(s<=150) return '<span class="pill warn">Medio</span>';
  if(s<=180) return '<span class="pill" style="background:rgba(251,146,60,.15);color:var(--accent-orange)">Lento</span>';
  return '<span class="pill bad">Muy Lento</span>';
}
function fmtMoney(v) { return '$'+Number(v).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function fmtNum(v) { return Number(v).toLocaleString('en-US'); }
function esc(s) { return String(s).replace(/'/g,"\\'"); }

// =============== DATE FILTER HELPERS ===============
function getDateRange() {
  const dates = D.daily.map(d=>d.date).sort();
  const minD = dates[0], maxD = dates[dates.length-1];
  const today = maxD; // last date in dataset
  const yesterday = dates.length>1 ? dates[dates.length-2] : minD;
  if(dateFilter==='all') return {start:minD,end:maxD};
  if(dateFilter==='today') return {start:today,end:today};
  if(dateFilter==='yesterday') return {start:yesterday,end:yesterday};
  if(dateFilter==='custom' && dateCustomStart && dateCustomEnd) return {start:dateCustomStart,end:dateCustomEnd};
  // For lastN days
  const maxDate = new Date(maxD);
  let daysBack = 0;
  if(dateFilter==='last7') daysBack=6;
  else if(dateFilter==='last30') daysBack=29;
  else if(dateFilter==='last90') daysBack=89;
  else if(dateFilter==='last365') daysBack=364;
  else if(dateFilter==='thisMonth') { const s=new Date(maxDate.getFullYear(),maxDate.getMonth(),1); return {start:s.toISOString().slice(0,10),end:maxD}; }
  else if(dateFilter==='lastMonth') { const s=new Date(maxDate.getFullYear(),maxDate.getMonth()-1,1); const e=new Date(maxDate.getFullYear(),maxDate.getMonth(),0); return {start:s.toISOString().slice(0,10),end:e.toISOString().slice(0,10)}; }
  if(daysBack>0) { const s=new Date(maxDate); s.setDate(s.getDate()-daysBack); return {start:s.toISOString().slice(0,10),end:maxD}; }
  return {start:minD,end:maxD};
}
function filterByDateRange(arr, dateField) {
  const {start,end} = getDateRange();
  return arr.filter(d => d[dateField]>=start && d[dateField]<=end);
}
function getFilteredDaily() { return filterByDateRange(D.daily,'date'); }
function getFilteredDailyHourly() { return filterByDateRange(D.daily_hourly,'date'); }
function getFilteredDailyModel() {
  let dm = filterByDateRange(D.daily_model,'date');
  if(selectedModels.length>0) dm = dm.filter(d=>selectedModels.includes(d.model));
  return dm;
}
function computeFilteredGeneral() {
  const fd = getFilteredDaily();
  const fdm = getFilteredDailyModel();
  const fdh = getFilteredDailyHourly();
  // Aggregate daily data
  const sales_net = fd.reduce((s,d)=>s+d.sales_net,0);
  const msg_sales = fd.reduce((s,d)=>s+d.msg_sales,0);
  const sub_sales = fd.reduce((s,d)=>s+d.sub_sales,0);
  const tips = fd.reduce((s,d)=>s+d.tips,0);
  const messages = fd.reduce((s,d)=>s+d.messages,0);
  const fans_chatted = fd.reduce((s,d)=>s+d.fans_chatted,0);
  const ppv_sent = fd.reduce((s,d)=>s+d.ppv_sent,0);
  const transactions = fd.reduce((s,d)=>s+d.transactions,0);
  // If model filter active, use daily_model data instead
  let rev=sales_net, msgR=msg_sales, subR=sub_sales, tipR=tips, msgs=messages, fc=fans_chatted, ppv=ppv_sent;
  if(selectedModels.length>0) {
    rev=fdm.reduce((s,d)=>s+d.sales_net,0); msgR=fdm.reduce((s,d)=>s+d.msg_sales,0);
    subR=fdm.reduce((s,d)=>s+d.sub_sales,0); tipR=fdm.reduce((s,d)=>s+d.tips,0);
    msgs=fdm.reduce((s,d)=>s+d.messages,0); fc=fdm.reduce((s,d)=>s+d.fans_chatted,0);
    ppv=fdm.reduce((s,d)=>s+d.ppv_sent,0);
  }
  // Build hourly from daily_hourly
  const hourly = Array.from({length:24},(_,h)=>({hour:h,hour_label:`${String(h).padStart(2,'0')}:00`,fans_chatted:0,messages:0,ppv_sent:0,sales_net:0,msg_sales_net:0,sub_sales_net:0,tips_net:0,transactions:0}));
  const src = selectedModels.length>0 ? fdm : fdh;
  // For model-filtered, we need hourly from daily_model which doesn't have hourly granularity
  // So use daily_hourly and filter by model if possible
  if(selectedModels.length>0) {
    // Filter daily_hourly entries where... we don't have model in daily_hourly
    // Use model.hourly data instead
    const selModels = D.models.filter(m=>selectedModels.includes(m.name));
    selModels.forEach(m=>{
      m.hourly.forEach(mh=>{hourly[mh.hour].fans_chatted+=mh.fans_chatted||0; hourly[mh.hour].sales_net+=mh.sales_net||0; hourly[mh.hour].messages+=mh.messages||0; hourly[mh.hour].ppv_sent+=mh.ppv_sent||0;});
    });
  } else {
    fdh.forEach(dh=>{const h=hourly[dh.hour]; h.fans_chatted+=dh.fans_chatted; h.sales_net+=dh.sales_net; h.messages+=dh.messages; h.ppv_sent+=dh.ppv_sent; h.msg_sales_net+=dh.msg_sales_net; h.sub_sales_net+=dh.sub_sales_net; h.tips_net+=dh.tips_net; h.transactions+=dh.transactions;});
  }
  const peakTraffic = hourly.reduce((a,b)=>b.fans_chatted>a.fans_chatted?b:a, hourly[0]);
  const peakSales = hourly.reduce((a,b)=>b.sales_net>a.sales_net?b:a, hourly[0]);
  const grRatio = msgs>0?round2(ppv/msgs*100):0;
  return {rev,msgR,subR,tipR,msgs,fc,ppv,hourly,peakTraffic,peakSales,grRatio,days:fd.length};
}
function round2(v){return Math.round(v*100)/100;}
function getDateFilterLabel() {
  const labels={'all':'Todo el periodo','today':'Hoy','yesterday':'Ayer','last7':'Ultimos 7 dias','last30':'Ultimos 30 dias','last90':'Ultimos 90 dias','last365':'Ultimo ano','thisMonth':'Este mes','lastMonth':'Mes anterior','custom':'Personalizado'};
  return labels[dateFilter]||'Todo el periodo';
}
function setDateFilter(f) {
  dateFilter=f;
  document.querySelectorAll('.date-opt').forEach(o=>o.classList.toggle('active',o.dataset.filter===f));
  if(f!=='custom') { renderGeneral(); closeDatePanel(); }
}
function applyCustomDate() {
  const s=$('dateStart').value, e=$('dateEnd').value;
  if(s&&e){dateCustomStart=s;dateCustomEnd=e;dateFilter='custom';renderGeneral();closeDatePanel();}
}
function closeDatePanel(){const p=$('dateFP');if(p)p.classList.remove('open');}
function closeModelPanel(){const p=$('modelFP');if(p)p.classList.remove('open');}
function toggleModelSelection(name) {
  const idx=selectedModels.indexOf(name);
  if(idx>-1) selectedModels.splice(idx,1); else selectedModels.push(name);
  renderGeneral(); renderModels(); renderChatters(); renderHourly();
}
function setModelQuickFilter(type) {
  if(type==='all') selectedModels=[];
  else selectedModels=D.models.filter(m=>m.account_type===type).map(m=>m.name);
  updateModelCheckboxes();
  renderGeneral(); renderModels(); renderChatters(); renderHourly();
}
function updateModelCheckboxes() {
  document.querySelectorAll('.model-chk').forEach(cb=>{cb.checked=selectedModels.length===0||selectedModels.includes(cb.value);});
  document.querySelectorAll('.mq-btn').forEach(b=>b.classList.remove('active'));
  if(selectedModels.length===0) document.querySelector('.mq-btn[data-t="all"]')?.classList.add('active');
}
function filterModelList(q) {
  const ql=q.toLowerCase();
  document.querySelectorAll('.model-opt-row').forEach(r=>{r.style.display=r.dataset.name.toLowerCase().includes(ql)?'':'none';});
}

// =============== GENERAL ===============
function renderGeneral() {
  const g = D.general;
  const f = computeFilteredGeneral();
  const isFiltered = dateFilter!=='all' || selectedModels.length>0;
  const rev=isFiltered?f.rev:g.total_net_revenue;
  const msgR=isFiltered?f.msgR:g.msg_revenue;
  const subR=isFiltered?f.subR:g.sub_revenue;
  const tipR=isFiltered?f.tipR:g.tips_revenue;
  const msgs=isFiltered?f.msgs:g.total_messages;
  const fc=isFiltered?f.fc:g.total_fans_chatted;
  const ppv=isFiltered?f.ppv:g.total_ppv_sent;
  const hr=isFiltered?f.hourly:D.hourly;
  const peakT=isFiltered?f.peakTraffic:D.peak_traffic_hour;
  const peakS=isFiltered?f.peakSales:D.peak_sales_hour;
  const grR=isFiltered?f.grRatio:g.golden_ratio;
  const days=isFiltered?f.days:g.days_in_range;
  // Date range info
  const dateRng=getDateRange();
  const dateLabel=dateFilter==='all'?D.report_date:`${dateRng.start} - ${dateRng.end}`;
  const modLabel=selectedModels.length>0?selectedModels.length+' modelo'+(selectedModels.length>1?'s':''):'Todos';
  // Build date options
  const dateOpts = [
    {id:'all',label:'Todo el periodo'},
    {id:'today',label:'Hoy (ultimo dia)'},
    {id:'yesterday',label:'Ayer'},
    {id:'last7',label:'Ultimos 7 dias'},
    {id:'last30',label:'Ultimos 30 dias'},
    {id:'thisMonth',label:'Este mes'},
    {id:'lastMonth',label:'Mes anterior'},
  ];
  $('tab-general').innerHTML = `
    <div class="filter-bar">
      <div class="filter-dropdown">
        <button class="filter-btn ${dateFilter!=='all'?'has-filter':''}" onclick="event.stopPropagation();$('dateFP').classList.toggle('open');closeModelPanel();">&#128197; ${getDateFilterLabel()} &#9662;</button>
        <div class="filter-panel" id="dateFP">
          <div class="filter-panel-header"><h4>Rango de Fechas</h4><span style="font-size:10px;color:var(--text-muted)">${days} dias</span></div>
          <div class="filter-panel-body">
            ${dateOpts.map(o=>`<div class="filter-option date-opt ${dateFilter===o.id?'active':''}" data-filter="${o.id}" onclick="setDateFilter('${o.id}')">${o.label}</div>`).join('')}
          </div>
          <div class="date-custom-row">
            <input type="date" id="dateStart" value="${dateCustomStart||dateRng.start}" min="${D.daily[0]?.date}" max="${D.daily[D.daily.length-1]?.date}">
            <input type="date" id="dateEnd" value="${dateCustomEnd||dateRng.end}" min="${D.daily[0]?.date}" max="${D.daily[D.daily.length-1]?.date}">
            <button class="filter-quick-btn" onclick="applyCustomDate()" style="padding:5px 10px">Aplicar</button>
          </div>
        </div>
      </div>
      <div class="filter-dropdown">
        <button class="filter-btn ${selectedModels.length>0?'has-filter':''}" onclick="event.stopPropagation();$('modelFP').classList.toggle('open');closeDatePanel();">&#128100; ${modLabel} &#9662;</button>
        <div class="filter-panel" id="modelFP" style="min-width:300px">
          <div class="filter-panel-header"><h4>Filtrar Modelos</h4></div>
          <div class="filter-quick-btns">
            <button class="filter-quick-btn mq-btn ${selectedModels.length===0?'active':''}" data-t="all" onclick="setModelQuickFilter('all')">Todos</button>
            <button class="filter-quick-btn mq-btn" data-t="free" onclick="setModelQuickFilter('free')">Free</button>
            <button class="filter-quick-btn mq-btn" data-t="paid" onclick="setModelQuickFilter('paid')">Paid</button>
            <button class="filter-quick-btn mq-btn" data-t="mixta" onclick="setModelQuickFilter('mixta')">Mixtas</button>
          </div>
          <div style="padding:6px 12px"><input class="filter-search" placeholder="Buscar modelo..." oninput="filterModelList(this.value)"></div>
          <div class="filter-panel-body">
            ${D.models.map(m=>`<label class="filter-option model-opt-row" data-name="${m.name}"><input type="checkbox" class="model-chk" value="${m.name}" ${selectedModels.length===0||selectedModels.includes(m.name)?'checked':''} onchange="toggleModelSelection('${esc(m.name)}')">${m.name} <span style="font-size:9px;color:var(--text-muted);margin-left:auto">${m.account_type}</span></label>`).join('')}
          </div>
        </div>
      </div>
      ${isFiltered?`<span class="filter-active-label">Filtro activo: ${dateLabel} | ${modLabel}</span>`:''}
    </div>
    <div class="kpi-grid">
      <div class="kpi-card"><div class="kpi-label">Revenue Total (Net)</div><div class="kpi-value green">${fmtMoney(rev)}</div><div class="kpi-detail">${days} dias</div></div>
      <div class="kpi-card"><div class="kpi-label">Revenue Mensajes</div><div class="kpi-value blue">${fmtMoney(msgR)}</div><div class="kpi-detail">PPV + mensajes pagados</div></div>
      <div class="kpi-card"><div class="kpi-label">Revenue Suscripciones</div><div class="kpi-value purple">${fmtMoney(subR)}</div></div>
      <div class="kpi-card"><div class="kpi-label">Revenue Tips</div><div class="kpi-value orange">${fmtMoney(tipR)}</div></div>
      <div class="kpi-card"><div class="kpi-label">Total Mensajes</div><div class="kpi-value blue">${fmtNum(msgs)}</div><div class="kpi-detail">${g.total_chatters} chatters</div></div>
      <div class="kpi-card"><div class="kpi-label">PPV Enviados</div><div class="kpi-value yellow">${fmtNum(ppv)}</div></div>
      <div class="kpi-card"><div class="kpi-label">Golden Ratio</div><div class="kpi-value ${grR>=5?'green':grR>=3?'yellow':'red'}">${grR}%</div><div class="kpi-detail">PPV / Total mensajes</div></div>
      <div class="kpi-card"><div class="kpi-label">Fans Chateados</div><div class="kpi-value purple">${fmtNum(fc)}</div></div>
      <div class="kpi-card"><div class="kpi-label">New Subs Revenue</div><div class="kpi-value cyan">${fmtMoney(g.new_subs_revenue)}</div></div>
      <div class="kpi-card"><div class="kpi-label">Resp. Promedio</div><div class="kpi-value pink">${g.avg_replay_formatted}</div><div class="kpi-detail">Mediana: ${g.median_replay_formatted}</div></div>
    </div>
    <div class="peak-grid">
      <div class="peak-card"><div class="peak-icon traffic">&#128200;</div><div class="peak-info"><h4>Hora Pico Trafico</h4><div class="pv" style="color:var(--accent-blue)">${peakT.hour_label}</div><div class="pd">${fmtNum(peakT.fans_chatted)} fans chateados</div></div></div>
      <div class="peak-card"><div class="peak-icon sales">&#128176;</div><div class="peak-info"><h4>Hora Pico Ventas</h4><div class="pv" style="color:var(--accent-green)">${peakS.hour_label}</div><div class="pd">${fmtMoney(peakS.sales_net||peakS.revenue||0)}</div></div></div>
      <div class="peak-card"><div class="peak-icon speed">&#9889;</div><div class="peak-info"><h4>Velocidad Respuesta</h4><div class="pv" style="color:var(--accent-yellow)">${g.avg_replay_formatted}</div><div class="pd">Mediana: ${g.median_replay_formatted}</div></div></div>
      <div class="peak-card"><div class="peak-icon fans">&#128101;</div><div class="peak-info"><h4>Fans Nuevos</h4><div class="pv" style="color:var(--accent-purple)">${fmtNum(g.total_new_fans)}</div><div class="pd">${fmtNum(g.total_active_fans)} activos total</div></div></div>
    </div>
    <div class="charts-grid">
      <div class="chart-card full"><div class="chart-title"><span class="dot blue"></span> Fans Chateados vs Revenue por Hora</div><div class="chart-container"><canvas id="cGenHourly"></canvas></div></div>
    </div>
    <div class="charts-grid">
      <div class="chart-card"><div class="chart-title"><span class="dot green"></span> Top 10 Modelos por Revenue</div><div class="chart-container"><canvas id="cTopModRev"></canvas></div></div>
      <div class="chart-card"><div class="chart-title"><span class="dot purple"></span> Top 10 Chatters por Ventas</div><div class="chart-container"><canvas id="cTopChatRev"></canvas></div></div>
    </div>
    <div class="charts-grid">
      <div class="chart-card"><div class="chart-title"><span class="dot cyan"></span> Revenue por Tipo</div><div class="chart-container"><canvas id="cRevType"></canvas></div></div>
      <div class="chart-card"><div class="chart-title"><span class="dot yellow"></span> Revenue Diario</div><div class="chart-container"><canvas id="cDailyRev"></canvas></div></div>
    </div>
  `;
  // Charts
  const lbl = hr.map(x=>x.hour_label);
  cc('cGenHourly',{type:'bar',data:{labels:lbl,datasets:[
    {label:'Fans Chateados',data:hr.map(x=>x.fans_chatted),backgroundColor:'rgba(79,140,255,.6)',borderRadius:4,yAxisID:'y',order:2},
    {label:'Revenue ($)',data:hr.map(x=>x.sales_net),borderColor:'rgba(52,211,153,1)',backgroundColor:'rgba(52,211,153,.1)',borderWidth:2,type:'line',fill:true,tension:.3,pointRadius:3,yAxisID:'y1',order:1}
  ]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{labels:{color:'#9ca3af'}}},scales:{x:{grid:{color:'#1e2235'},ticks:{color:'#6b7280'}},y:{position:'left',grid:{color:'#1e2235'},ticks:{color:'#6b7280'}},y1:{position:'right',grid:{display:false},ticks:{color:'#34d399',callback:v=>'$'+v}}}}});

  const filteredModels = selectedModels.length>0?D.models.filter(m=>selectedModels.includes(m.name)):D.models;
  const topM = filteredModels.slice(0,10);
  cc('cTopModRev',{type:'bar',data:{labels:topM.map(m=>m.name),datasets:[{data:topM.map(m=>m.total_earnings),backgroundColor:topM.map((_,i)=>`hsla(${150+i*15},70%,50%,.7)`),borderRadius:6}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>fmtMoney(c.raw)}}},scales:{x:{grid:{color:'#1e2235'},ticks:{color:'#6b7280',callback:v=>'$'+v}},y:{grid:{display:false},ticks:{color:'#9ca3af',font:{size:10}}}}}});

  const topC = D.chatters.slice(0,10);
  cc('cTopChatRev',{type:'bar',data:{labels:topC.map(c=>c.name.split(' ').slice(0,2).join(' ')),datasets:[{data:topC.map(c=>c.total_sales),backgroundColor:topC.map((_,i)=>`hsla(${260+i*12},65%,55%,.7)`),borderRadius:6}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>fmtMoney(c.raw)}}},scales:{x:{grid:{color:'#1e2235'},ticks:{color:'#6b7280',callback:v=>'$'+v}},y:{grid:{display:false},ticks:{color:'#9ca3af',font:{size:10}}}}}});

  cc('cRevType',{type:'doughnut',data:{labels:['Mensajes','Suscripciones','Tips'],datasets:[{data:[msgR,subR,tipR],backgroundColor:['rgba(79,140,255,.8)','rgba(167,139,250,.8)','rgba(251,191,36,.8)'],borderColor:'transparent'}]},options:{responsive:true,maintainAspectRatio:false,cutout:'55%',plugins:{legend:{position:'bottom',labels:{color:'#9ca3af',padding:10}}}}});

  // Daily revenue chart
  const fd = getFilteredDaily();
  cc('cDailyRev',{type:'bar',data:{labels:fd.map(d=>d.date_label),datasets:[
    {label:'Revenue',data:fd.map(d=>d.sales_net),backgroundColor:'rgba(52,211,153,.6)',borderRadius:4},
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>fmtMoney(c.raw)}}},scales:{x:{grid:{color:'#1e2235'},ticks:{color:'#6b7280'}},y:{grid:{color:'#1e2235'},ticks:{color:'#6b7280',callback:v=>'$'+v}}}}});
}

// =============== SHIFTS ===============
function renderShifts() {
  ['turno1','turno2','turno3'].forEach(key => {
    const s = D.shifts[key]; if(!s) return;
    const el = $('tab-'+key);
    el.innerHTML = `
      <div class="section-title">${s.label}</div>
      <div class="kpi-grid">
        <div class="kpi-card"><div class="kpi-label">Revenue Net</div><div class="kpi-value green">${fmtMoney(s.sales_net)}</div></div>
        <div class="kpi-card"><div class="kpi-label">Mensajes</div><div class="kpi-value blue">${fmtNum(s.messages)}</div></div>
        <div class="kpi-card"><div class="kpi-label">Rev. Mensajes</div><div class="kpi-value cyan">${fmtMoney(s.msg_sales)}</div></div>
        <div class="kpi-card"><div class="kpi-label">Rev. Subs</div><div class="kpi-value purple">${fmtMoney(s.sub_sales)}</div></div>
        <div class="kpi-card"><div class="kpi-label">Rev. Tips</div><div class="kpi-value orange">${fmtMoney(s.tips_sales)}</div></div>
        <div class="kpi-card"><div class="kpi-label">Transacciones</div><div class="kpi-value yellow">${s.transactions}</div></div>
        <div class="kpi-card"><div class="kpi-label">PPV Enviados</div><div class="kpi-value blue">${s.ppv_sent}</div></div>
        <div class="kpi-card"><div class="kpi-label">Resp. Promedio</div><div class="kpi-value pink">${s.avg_replay_formatted}</div></div>
      </div>
      <div class="charts-grid">
        <div class="chart-card full"><div class="chart-title"><span class="dot blue"></span> Actividad por Hora</div><div class="chart-container"><canvas id="cShift_${key}"></canvas></div></div>
      </div>
      <div class="charts-grid">
        <div class="chart-card"><div class="chart-title"><span class="dot green"></span> Top Modelos</div><div class="chart-container"><canvas id="cShiftMod_${key}"></canvas></div></div>
        <div class="chart-card"><div class="chart-title"><span class="dot purple"></span> Top Chatters</div><div class="chart-container"><canvas id="cShiftChat_${key}"></canvas></div></div>
      </div>
    `;
    const hl = s.hourly, lbls = hl.map(x=>x.hour_label);
    cc('cShift_'+key,{type:'bar',data:{labels:lbls,datasets:[
      {label:'Mensajes',data:hl.map(x=>x.messages),backgroundColor:'rgba(79,140,255,.6)',borderRadius:4,yAxisID:'y'},
      {label:'Revenue',data:hl.map(x=>x.sales_net),borderColor:'rgba(52,211,153,1)',backgroundColor:'rgba(52,211,153,.1)',borderWidth:2,type:'line',fill:true,tension:.3,pointRadius:3,yAxisID:'y1'}
    ]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{labels:{color:'#9ca3af'}}},scales:{x:{grid:{color:'#1e2235'},ticks:{color:'#6b7280'}},y:{grid:{color:'#1e2235'},ticks:{color:'#6b7280'}},y1:{position:'right',grid:{display:false},ticks:{color:'#34d399',callback:v=>'$'+v}}}}});

    if(s.top_models.length) {
      cc('cShiftMod_'+key,{type:'bar',data:{labels:s.top_models.map(m=>m.name),datasets:[{data:s.top_models.map(m=>m.revenue),backgroundColor:s.top_models.map((_,i)=>`hsla(${150+i*18},70%,50%,.7)`),borderRadius:5}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>fmtMoney(c.raw)}}},scales:{x:{grid:{color:'#1e2235'},ticks:{color:'#6b7280',callback:v=>'$'+v}},y:{grid:{display:false},ticks:{color:'#9ca3af',font:{size:10}}}}}});
    }
    if(s.top_chatters.length) {
      cc('cShiftChat_'+key,{type:'bar',data:{labels:s.top_chatters.map(c=>c.name.split(' ').slice(0,2).join(' ')),datasets:[{data:s.top_chatters.map(c=>c.revenue),backgroundColor:s.top_chatters.map((_,i)=>`hsla(${260+i*14},65%,55%,.7)`),borderRadius:5}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>fmtMoney(c.raw)}}},scales:{x:{grid:{color:'#1e2235'},ticks:{color:'#6b7280',callback:v=>'$'+v}},y:{grid:{display:false},ticks:{color:'#9ca3af',font:{size:10}}}}}});
    }
  });
}

// =============== MODELS ===============
let modelFilter = 'all';
function setModelFilter(type, btn) {
  modelFilter = type;
  document.querySelectorAll('.model-filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const rows = $('modTbl').querySelectorAll('tbody tr');
  rows.forEach(r => {
    if(type==='all') { r.style.display=''; return; }
    r.style.display = r.getAttribute('data-type')===type ? '' : 'none';
  });
  // Update count
  const visible = Array.from(rows).filter(r=>r.style.display!=='none').length;
  $('modFilterCount').textContent = visible + ' modelos';
}

function renderModels() {
  const el = $('tab-models');
  const visModels = selectedModels.length>0?D.models.filter(m=>selectedModels.includes(m.name)):D.models;
  const freeCount = visModels.filter(m=>m.account_type==='free').length;
  const paidCount = visModels.filter(m=>m.account_type==='paid').length;
  const mixtaCount = visModels.filter(m=>m.account_type==='mixta').length;
  el.innerHTML = `
    <div class="section-title">Analisis por Modelo <span class="count" id="modFilterCount">${visModels.length} modelos</span></div>
    <div style="display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap">
      <button class="nav-tab model-filter-btn active" onclick="setModelFilter('all',this)" style="padding:7px 16px;font-size:12px">Todos (${visModels.length})</button>
      <button class="nav-tab model-filter-btn" onclick="setModelFilter('free',this)" style="padding:7px 16px;font-size:12px;border:1px solid rgba(52,211,153,.3)">Free (${freeCount})</button>
      <button class="nav-tab model-filter-btn" onclick="setModelFilter('paid',this)" style="padding:7px 16px;font-size:12px;border:1px solid rgba(167,139,250,.3)">Paid (${paidCount})</button>
      <button class="nav-tab model-filter-btn" onclick="setModelFilter('mixta',this)" style="padding:7px 16px;font-size:12px;border:1px solid rgba(251,191,36,.3)">Mixtas (${mixtaCount})</button>
    </div>
    <div class="table-card">
      <div class="table-header"><h3>Modelos</h3><input class="search-input" placeholder="Buscar modelo..." oninput="filterTbl('modTbl',this.value)"></div>
      <div class="table-scroll">
        <table class="data-table" id="modTbl"><thead><tr>
          <th onclick="sortTbl('modTbl',0,'n')">#</th>
          <th onclick="sortTbl('modTbl',1,'t')">Modelo</th>
          <th>Tipo</th>
          <th onclick="sortTbl('modTbl',3,'n')" class="num">Total Earn.</th>
          <th onclick="sortTbl('modTbl',4,'n')" class="num">LTV</th>
          <th onclick="sortTbl('modTbl',5,'n')" class="num">Msg Rev.</th>
          <th onclick="sortTbl('modTbl',6,'n')" class="num">New Subs</th>
          <th onclick="sortTbl('modTbl',7,'n')" class="num">Rec Subs</th>
          <th onclick="sortTbl('modTbl',8,'n')" class="num">Tips</th>
          <th onclick="sortTbl('modTbl',9,'n')" class="num">New Fans</th>
          <th onclick="sortTbl('modTbl',10,'n')" class="num">Active Fans</th>
          <th onclick="sortTbl('modTbl',11,'t')">Avg Sub Len</th>
          <th onclick="sortTbl('modTbl',12,'n')" class="num">PPV Env.</th>
          <th onclick="sortTbl('modTbl',13,'n')" class="num">PPV Unl.</th>
          <th onclick="sortTbl('modTbl',14,'n')" class="num">Golden R.</th>
          <th onclick="sortTbl('modTbl',15,'n')" class="num">Unlock R.</th>
          <th onclick="sortTbl('modTbl',16,'n')" class="num">Fan CVR</th>
          <th onclick="sortTbl('modTbl',17,'t')">Resp.</th>
          <th>Peak Traf.</th>
          <th>Peak Vtas.</th>
        </tr></thead><tbody id="modTblBody"></tbody></table>
      </div>
    </div>
  `;
  const typeBadge = (t) => t==='free'?'<span class="pill" style="background:rgba(52,211,153,.15);color:var(--accent-green)">Free</span>':t==='paid'?'<span class="pill" style="background:rgba(167,139,250,.15);color:var(--accent-purple)">Paid</span>':t==='mixta'?'<span class="pill" style="background:rgba(251,191,36,.15);color:#fbbf24">Mixta</span>':'<span class="pill warn">?</span>';
  $('modTblBody').innerHTML = visModels.map((m,i) => `<tr data-type="${m.account_type}">
    <td data-sort="${i}">${rb(i)}</td>
    <td><a class="clickable" onclick="openModel('${esc(m.name)}')">${m.name}</a></td>
    <td>${typeBadge(m.account_type)}</td>
    <td class="num" data-sort="${m.total_earnings}" style="color:var(--accent-green);font-weight:600">${fmtMoney(m.total_earnings)}</td>
    <td class="num" data-sort="${m.ltv}" style="color:var(--accent-cyan);font-weight:600">${fmtMoney(m.ltv)}</td>
    <td class="num" data-sort="${m.message_revenue}">${fmtMoney(m.message_revenue)}</td>
    <td class="num" data-sort="${m.new_subs_revenue}" style="color:var(--accent-cyan)">${fmtMoney(m.new_subs_revenue)}</td>
    <td class="num" data-sort="${m.recurring_subs_revenue}">${fmtMoney(m.recurring_subs_revenue)}</td>
    <td class="num" data-sort="${m.tips_revenue}">${fmtMoney(m.tips_revenue)}</td>
    <td class="num" data-sort="${m.new_fans}">${m.new_fans}</td>
    <td class="num" data-sort="${m.active_fans}">${fmtNum(m.active_fans)}</td>
    <td data-sort="${m.avg_sub_days}">${m.avg_sub_length}</td>
    <td class="num" data-sort="${m.ppv_sent}">${m.ppv_sent}</td>
    <td class="num" data-sort="${m.ppv_unlocked}">${m.ppv_unlocked}</td>
    <td class="num" data-sort="${m.golden_ratio}">${grPill(m.golden_ratio)}</td>
    <td class="num" data-sort="${m.unlock_ratio}">${urPill(m.unlock_ratio)}</td>
    <td class="num" data-sort="${m.fan_cvr}">${m.fan_cvr}%</td>
    <td data-sort="${m.avg_replay_seconds}">${m.avg_replay_formatted} ${rtPill(m.avg_replay_seconds)}</td>
    <td><span class="badge">${m.peak_traffic_hour}</span></td>
    <td><span class="badge">${m.peak_sales_hour}</span></td>
  </tr>`).join('');
}

// =============== CHATTERS ===============
function renderChatters() {
  const el = $('tab-chatters');
  const visChatters = selectedModels.length>0?D.chatters.filter(c=>c.models.some(m=>selectedModels.includes(m.name))):D.chatters;
  el.innerHTML = `
    <div class="section-title">Analisis por Chatter <span class="count">${visChatters.length} chatters</span></div>
    <div class="table-card">
      <div class="table-header"><h3>Todos los Chatters</h3><input class="search-input" placeholder="Buscar chatter..." oninput="filterTbl('chatTbl',this.value)"></div>
      <div class="table-scroll">
        <table class="data-table" id="chatTbl"><thead><tr>
          <th onclick="sortTbl('chatTbl',0,'n')">#</th>
          <th onclick="sortTbl('chatTbl',1,'t')">Chatter</th>
          <th onclick="sortTbl('chatTbl',2,'t')">Equipo</th>
          <th onclick="sortTbl('chatTbl',3,'n')" class="num">Ventas</th>
          <th onclick="sortTbl('chatTbl',4,'n')" class="num">Modelos</th>
          <th onclick="sortTbl('chatTbl',5,'n')" class="num">Msgs</th>
          <th onclick="sortTbl('chatTbl',6,'n')" class="num">PPV Env.</th>
          <th onclick="sortTbl('chatTbl',7,'n')" class="num">Golden R.</th>
          <th onclick="sortTbl('chatTbl',8,'n')" class="num">PPV Unl.</th>
          <th onclick="sortTbl('chatTbl',9,'n')" class="num">Unlock R.</th>
          <th onclick="sortTbl('chatTbl',10,'n')" class="num">Fans Chat.</th>
          <th onclick="sortTbl('chatTbl',11,'n')" class="num">Fans Spent</th>
          <th onclick="sortTbl('chatTbl',12,'n')" class="num">Fan CVR</th>
          <th onclick="sortTbl('chatTbl',13,'n')" class="num">Avg $/Spndr</th>
          <th onclick="sortTbl('chatTbl',14,'n')" class="num">Chars</th>
          <th onclick="sortTbl('chatTbl',15,'t')">Resp.</th>
          <th onclick="sortTbl('chatTbl',16,'n')" class="num">Clocked H.</th>
          <th onclick="sortTbl('chatTbl',17,'n')" class="num">$/Hora</th>
          <th onclick="sortTbl('chatTbl',18,'n')" class="num">Msgs/Hora</th>
          <th>Vel. Resp.</th>
        </tr></thead><tbody id="chatTblBody"></tbody></table>
      </div>
    </div>
  `;
  $('chatTblBody').innerHTML = visChatters.map((c,i) => {
    const tb = c.response_buckets;
    const tot = tb.under_2m+tb.btwn_2_5m+tb.btwn_5_10m+tb.over_10m;
    const fp = tot>0?Math.round((tb.under_2m+tb.btwn_2_5m)/tot*100):0;
    const fc = fp>=70?'var(--accent-green)':fp>=50?'var(--accent-yellow)':'var(--accent-red)';
    const clockH = c.clocked_minutes>0?(c.clocked_minutes/60).toFixed(1):'N/A';
    const mPerH = c.msgs_per_hour||0;
    const avgES = c.avg_earn_per_spender||0;
    return `<tr>
      <td data-sort="${i}">${rb(i)}</td>
      <td><a class="clickable" onclick="openChatter('${esc(c.name)}')">${c.name}</a></td>
      <td>${c.group}</td>
      <td class="num" data-sort="${c.total_sales}" style="color:var(--accent-green);font-weight:600">${fmtMoney(c.total_sales)}</td>
      <td class="num" data-sort="${c.models_count}">${c.models_count}</td>
      <td class="num" data-sort="${c.total_messages}">${fmtNum(c.total_messages)}</td>
      <td class="num" data-sort="${c.ppv_sent}">${fmtNum(c.ppv_sent)}</td>
      <td class="num" data-sort="${c.golden_ratio}">${grPill(c.golden_ratio)}</td>
      <td class="num" data-sort="${c.ppv_unlocked}">${fmtNum(c.ppv_unlocked)}</td>
      <td class="num" data-sort="${c.unlock_ratio}">${urPill(c.unlock_ratio)}</td>
      <td class="num" data-sort="${c.fans_chatted}">${fmtNum(c.fans_chatted)}</td>
      <td class="num" data-sort="${c.fans_spent}">${fmtNum(c.fans_spent)}</td>
      <td class="num" data-sort="${c.fan_cvr}">${c.fan_cvr}%</td>
      <td class="num" data-sort="${avgES}">${fmtMoney(avgES)}</td>
      <td class="num" data-sort="${c.char_count}">${fmtNum(c.char_count)}</td>
      <td data-sort="${c.avg_replay_seconds}">${c.avg_replay_formatted} ${rtPill(c.avg_replay_seconds)}</td>
      <td class="num" data-sort="${c.clocked_minutes}">${clockH}h</td>
      <td class="num" data-sort="${c.sales_per_hour}">${fmtMoney(c.sales_per_hour)}</td>
      <td class="num" data-sort="${mPerH}">${mPerH.toFixed?mPerH.toFixed(1):mPerH}</td>
      <td data-sort="${fp}">${fp}%<div class="progress-bar"><div class="progress-fill" style="width:${fp}%;background:${fc}"></div></div></td>
    </tr>`;
  }).join('');
}

// =============== HOURLY ===============
function renderHourly() {
  // If model filter active, aggregate hourly from selected models
  let h = D.hourly;
  if(selectedModels.length>0) {
    h = Array.from({length:24},(_,i)=>({hour:i,hour_label:`${String(i).padStart(2,'0')}:00`,fans_chatted:0,messages:0,ppv_sent:0,sales_net:0,msg_sales_net:0,sub_sales_net:0,tips_net:0}));
    D.models.filter(m=>selectedModels.includes(m.name)).forEach(m=>{m.hourly.forEach(mh=>{h[mh.hour].fans_chatted+=mh.fans_chatted||0; h[mh.hour].sales_net+=mh.sales_net||0; h[mh.hour].messages+=mh.messages||0; h[mh.hour].ppv_sent+=mh.ppv_sent||0;});});
  }
  const lbl = h.map(x=>x.hour_label);
  const peakT = h.reduce((a,b)=>b.fans_chatted>a.fans_chatted?b:a, h[0]);
  const peakS = h.reduce((a,b)=>b.sales_net>a.sales_net?b:a, h[0]);
  $('tab-hourly').innerHTML = `
    <div class="section-title">Analisis por Horas</div>
    <div class="peak-grid">
      <div class="peak-card"><div class="peak-icon traffic">&#128200;</div><div class="peak-info"><h4>Peak Trafico</h4><div class="pv" style="color:var(--accent-blue)">${peakT.hour_label}</div><div class="pd">${fmtNum(peakT.fans_chatted)} fans</div></div></div>
      <div class="peak-card"><div class="peak-icon sales">&#128176;</div><div class="peak-info"><h4>Peak Ventas</h4><div class="pv" style="color:var(--accent-green)">${peakS.hour_label}</div><div class="pd">${fmtMoney(peakS.sales_net)}</div></div></div>
    </div>
    <div class="charts-grid">
      <div class="chart-card full"><div class="chart-title"><span class="dot blue"></span> Fans Chateados por Hora</div><div class="chart-container"><canvas id="cHrTraffic"></canvas></div></div>
    </div>
    <div class="charts-grid">
      <div class="chart-card full"><div class="chart-title"><span class="dot green"></span> Revenue por Hora (desglosado)</div><div class="chart-container"><canvas id="cHrRevenue"></canvas></div></div>
    </div>
    <div class="charts-grid">
      <div class="chart-card full"><div class="chart-title"><span class="dot purple"></span> PPV Enviados por Hora</div><div class="chart-container"><canvas id="cHrPPV"></canvas></div></div>
    </div>
  `;
  cc('cHrTraffic',{type:'bar',data:{labels:lbl,datasets:[{label:'Fans Chateados',data:h.map(x=>x.fans_chatted),backgroundColor:h.map(x=>{const mx=Math.max(...h.map(z=>z.fans_chatted));const r=mx>0?x.fans_chatted/mx:0;return r>.9?'rgba(79,140,255,.9)':r>.6?'rgba(79,140,255,.6)':'rgba(79,140,255,.3)';}),borderRadius:5}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{color:'#1e2235'},ticks:{color:'#6b7280'}},y:{grid:{color:'#1e2235'},ticks:{color:'#6b7280'}}}}});

  cc('cHrRevenue',{type:'bar',data:{labels:lbl,datasets:[
    {label:'Mensajes',data:h.map(x=>x.msg_sales_net||0),backgroundColor:'rgba(79,140,255,.7)',borderRadius:4},
    {label:'Suscripciones',data:h.map(x=>x.sub_sales_net||0),backgroundColor:'rgba(167,139,250,.7)',borderRadius:4},
    {label:'Tips',data:h.map(x=>x.tips_net||0),backgroundColor:'rgba(251,191,36,.7)',borderRadius:4}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#9ca3af'}},tooltip:{callbacks:{label:c=>c.dataset.label+': '+fmtMoney(c.raw)}}},scales:{x:{stacked:true,grid:{color:'#1e2235'},ticks:{color:'#6b7280'}},y:{stacked:true,grid:{color:'#1e2235'},ticks:{color:'#6b7280',callback:v=>'$'+v}}}}});

  cc('cHrPPV',{type:'bar',data:{labels:lbl,datasets:[{label:'PPV Enviados',data:h.map(x=>x.ppv_sent),backgroundColor:'rgba(167,139,250,.7)',borderRadius:5}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{color:'#1e2235'},ticks:{color:'#6b7280'}},y:{grid:{color:'#1e2235'},ticks:{color:'#6b7280'}}}}});
}

// =============== MODALS ===============
function openModel(name) {
  const m = D.models.find(x=>x.name===name); if(!m) return;
  const mid = 'md_'+Date.now();
  const tBadge = m.account_type==='free'?'<span class="pill" style="background:rgba(52,211,153,.15);color:var(--accent-green);font-size:12px;padding:4px 12px">FREE</span>':m.account_type==='mixta'?'<span class="pill" style="background:rgba(251,191,36,.15);color:#fbbf24;font-size:12px;padding:4px 12px">MIXTA</span>':'<span class="pill" style="background:rgba(167,139,250,.15);color:var(--accent-purple);font-size:12px;padding:4px 12px">PAID</span>';
  let html = `
    <div class="modal-header"><h2>${m.name} ${tBadge}</h2><button class="modal-close" onclick="closeModal()">&times;</button></div>
    <div class="kpi-grid" style="grid-template-columns:repeat(auto-fit,minmax(140px,1fr))">
      <div class="kpi-card"><div class="kpi-label">Total Earnings</div><div class="kpi-value green">${fmtMoney(m.total_earnings)}</div></div>
      <div class="kpi-card" style="border-color:var(--accent-cyan)"><div class="kpi-label">LTV (Earn/Fan)</div><div class="kpi-value cyan">${fmtMoney(m.ltv)}</div><div class="kpi-detail">Total earnings / fans activos</div></div>
      <div class="kpi-card"><div class="kpi-label">Msg Revenue</div><div class="kpi-value blue">${fmtMoney(m.message_revenue)}</div></div>
      <div class="kpi-card"><div class="kpi-label">New Subs</div><div class="kpi-value cyan">${fmtMoney(m.new_subs_revenue)}</div></div>
      <div class="kpi-card"><div class="kpi-label">Rec Subs</div><div class="kpi-value purple">${fmtMoney(m.recurring_subs_revenue)}</div></div>
      <div class="kpi-card"><div class="kpi-label">Tips</div><div class="kpi-value orange">${fmtMoney(m.tips_revenue)}</div></div>
      <div class="kpi-card"><div class="kpi-label">Fans Nuevos</div><div class="kpi-value cyan">${m.new_fans}</div></div>
      <div class="kpi-card"><div class="kpi-label">Active Fans</div><div class="kpi-value purple">${fmtNum(m.active_fans)}</div></div>
      <div class="kpi-card"><div class="kpi-label">Following</div><div class="kpi-value blue">${fmtNum(m.following)}</div></div>
    </div>
    <div class="sub-section">
      <h4>Suscripciones & LTV</h4>
      <div class="kpi-grid" style="grid-template-columns:repeat(auto-fit,minmax(140px,1fr))">
        <div class="kpi-card"><div class="kpi-label">Avg Sub Length (LTV)</div><div class="kpi-value yellow">${m.avg_sub_length}</div></div>
        <div class="kpi-card"><div class="kpi-label">Fans Renew On</div><div class="kpi-value green">${m.fans_renew_on}</div><div class="kpi-detail">${m.renew_on_pct}% de activos</div></div>
        <div class="kpi-card"><div class="kpi-label">Expired Change</div><div class="kpi-value ${m.expired_fans_change>0?'red':'green'}">${m.expired_fans_change>0?'+':''}${m.expired_fans_change}</div></div>
        <div class="kpi-card"><div class="kpi-label">Avg Spend/Spender</div><div class="kpi-value green">${fmtMoney(m.avg_spend_per_spender)}</div></div>
        <div class="kpi-card"><div class="kpi-label">Avg Spend/TX</div><div class="kpi-value blue">${fmtMoney(m.avg_spend_per_tx)}</div></div>
        <div class="kpi-card"><div class="kpi-label">Contribution</div><div class="kpi-value purple">${m.contribution_pct}%</div></div>
      </div>
    </div>
    <div class="sub-section">
      <h4>Performance</h4>
      <div class="kpi-grid" style="grid-template-columns:repeat(auto-fit,minmax(120px,1fr))">
        <div class="kpi-card"><div class="kpi-label">Mensajes</div><div class="kpi-value blue">${fmtNum(m.messages_sent)}</div></div>
        <div class="kpi-card"><div class="kpi-label">PPV Env.</div><div class="kpi-value yellow">${m.ppv_sent}</div></div>
        <div class="kpi-card"><div class="kpi-label">PPV Unl.</div><div class="kpi-value green">${m.ppv_unlocked}</div></div>
        <div class="kpi-card"><div class="kpi-label">Golden R.</div><div class="kpi-value">${grPill(m.golden_ratio)}</div></div>
        <div class="kpi-card"><div class="kpi-label">Unlock R.</div><div class="kpi-value">${urPill(m.unlock_ratio)}</div></div>
        <div class="kpi-card"><div class="kpi-label">Fan CVR</div><div class="kpi-value orange">${m.fan_cvr}%</div></div>
        <div class="kpi-card"><div class="kpi-label">Resp. Prom.</div><div class="kpi-value pink">${m.avg_replay_formatted}</div></div>
        <div class="kpi-card"><div class="kpi-label">Peak Traf.</div><div class="kpi-value blue">${m.peak_traffic_hour}</div></div>
        <div class="kpi-card"><div class="kpi-label">Peak Vtas.</div><div class="kpi-value green">${m.peak_sales_hour}</div></div>
      </div>
    </div>
    <div class="chart-card" style="margin-bottom:16px"><div class="chart-title"><span class="dot blue"></span> Actividad por Hora</div><div class="chart-container"><canvas id="cMod_${mid}"></canvas></div></div>
    <h3 style="margin-bottom:10px;font-size:14px">Chatters en ${m.name} (${m.chatters.length})</h3>
    <div class="table-scroll" style="max-height:350px"><table class="data-table"><thead><tr>
      <th>#</th><th>Chatter</th><th>Equipo</th><th class="num">Ventas</th><th class="num">Msgs</th><th class="num">PPV E.</th><th class="num">PPV U.</th><th class="num">GR</th><th class="num">UR</th><th class="num">CVR</th><th class="num">$/h</th><th>Resp.</th>
    </tr></thead><tbody>
      ${m.chatters.map((c,j)=>`<tr><td>${rb(j)}</td><td>${c.name}</td><td>${c.group}</td><td class="num" style="color:var(--accent-green);font-weight:600">${fmtMoney(c.sales)}</td><td class="num">${fmtNum(c.messages_sent)}</td><td class="num">${c.ppv_sent}</td><td class="num">${c.ppv_unlocked}</td><td class="num">${grPill(c.golden_ratio)}</td><td class="num">${urPill(c.unlock_ratio)}</td><td class="num">${c.fan_cvr}%</td><td class="num">${fmtMoney(c.sales_per_hour)}</td><td>${c.response_time} ${rtPill(c.response_seconds)}</td></tr>`).join('')}
    </tbody></table></div>
  `;
  $('modalContent').innerHTML = html;
  $('modalOverlay').classList.add('active');
  document.body.style.overflow = 'hidden';
  setTimeout(()=>{
    if(!m.hourly.length) return;
    const ah=Array.from({length:24},(_,i)=>i),hm={};
    m.hourly.forEach(h=>{hm[h.hour]=h;});
    cc('cMod_'+mid,{type:'bar',data:{labels:ah.map(h=>`${String(h).padStart(2,'0')}:00`),datasets:[
      {label:'Mensajes',data:ah.map(h=>hm[h]?hm[h].messages:0),backgroundColor:'rgba(79,140,255,.6)',borderRadius:4,yAxisID:'y'},
      {label:'Revenue',data:ah.map(h=>hm[h]?hm[h].sales_net:0),borderColor:'rgba(52,211,153,1)',backgroundColor:'rgba(52,211,153,.1)',borderWidth:2,type:'line',fill:true,tension:.3,pointRadius:3,yAxisID:'y1'}
    ]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{labels:{color:'#9ca3af'}}},scales:{x:{grid:{color:'#1e2235'},ticks:{color:'#6b7280',font:{size:9}}},y:{grid:{color:'#1e2235'},ticks:{color:'#6b7280'}},y1:{position:'right',grid:{display:false},ticks:{color:'#34d399',callback:v=>'$'+v}}}}});
  },100);
}

function openChatter(name) {
  const c = D.chatters.find(x=>x.name===name); if(!c) return;
  const mid = 'md_'+Date.now();
  const tb=c.response_buckets;
  let html = `
    <div class="modal-header"><h2>${c.name}</h2><button class="modal-close" onclick="closeModal()">&times;</button></div>
    <div style="margin-bottom:8px;color:var(--text-secondary);font-size:12px">${c.group} | Horas trabajadas: ${c.clocked_hours_formatted}</div>
    <div class="kpi-grid" style="grid-template-columns:repeat(auto-fit,minmax(130px,1fr))">
      <div class="kpi-card"><div class="kpi-label">Ventas</div><div class="kpi-value green">${fmtMoney(c.total_sales)}</div></div>
      <div class="kpi-card"><div class="kpi-label">$/Hora</div><div class="kpi-value cyan">${fmtMoney(c.sales_per_hour)}</div></div>
      <div class="kpi-card"><div class="kpi-label">Mensajes</div><div class="kpi-value blue">${fmtNum(c.total_messages)}</div></div>
      <div class="kpi-card"><div class="kpi-label">Fans</div><div class="kpi-value purple">${c.fans_chatted}</div></div>
      <div class="kpi-card"><div class="kpi-label">PPV Env.</div><div class="kpi-value yellow">${c.ppv_sent}</div></div>
      <div class="kpi-card"><div class="kpi-label">PPV Unl.</div><div class="kpi-value green">${c.ppv_unlocked}</div></div>
      <div class="kpi-card"><div class="kpi-label">Golden R.</div><div class="kpi-value">${grPill(c.golden_ratio)}</div></div>
      <div class="kpi-card"><div class="kpi-label">Unlock R.</div><div class="kpi-value">${urPill(c.unlock_ratio)}</div></div>
      <div class="kpi-card"><div class="kpi-label">Fan CVR</div><div class="kpi-value orange">${c.fan_cvr}%</div></div>
      <div class="kpi-card"><div class="kpi-label">Resp. Prom.</div><div class="kpi-value pink">${c.avg_replay_formatted}</div></div>
    </div>
    <div class="charts-grid" style="margin-top:14px">
      <div class="chart-card"><div class="chart-title"><span class="dot blue"></span> Actividad por Hora</div><div class="chart-container"><canvas id="cChat_${mid}"></canvas></div></div>
      <div class="chart-card"><div class="chart-title"><span class="dot yellow"></span> Velocidad de Respuesta</div><div class="chart-container"><canvas id="cChatResp_${mid}"></canvas></div></div>
    </div>
    <h3 style="margin:14px 0 10px;font-size:14px">Modelos trabajados (${c.models.length})</h3>
    <div class="table-scroll" style="max-height:350px"><table class="data-table"><thead><tr>
      <th>#</th><th>Modelo</th><th class="num">Ventas</th><th class="num">Msgs</th><th class="num">PPV E.</th><th class="num">PPV U.</th><th class="num">GR</th><th class="num">UR</th><th class="num">CVR</th><th class="num">$/h</th><th>Resp.</th>
    </tr></thead><tbody>
      ${c.models.map((m,j)=>`<tr><td>${rb(j)}</td><td>${m.name}</td><td class="num" style="color:var(--accent-green);font-weight:600">${fmtMoney(m.sales)}</td><td class="num">${fmtNum(m.messages_sent)}</td><td class="num">${m.ppv_sent}</td><td class="num">${m.ppv_unlocked}</td><td class="num">${grPill(m.golden_ratio)}</td><td class="num">${urPill(m.unlock_ratio)}</td><td class="num">${m.fan_cvr}%</td><td class="num">${fmtMoney(m.sales_per_hour)}</td><td>${m.response_time} ${rtPill(m.response_seconds)}</td></tr>`).join('')}
    </tbody></table></div>
  `;
  $('modalContent').innerHTML = html;
  $('modalOverlay').classList.add('active');
  document.body.style.overflow = 'hidden';
  setTimeout(()=>{
    if(c.hourly.length) {
      const ah=Array.from({length:24},(_,i)=>i),hm={};
      c.hourly.forEach(h=>{hm[h.hour]=h;});
      cc('cChat_'+mid,{type:'bar',data:{labels:ah.map(h=>`${String(h).padStart(2,'0')}:00`),datasets:[
        {label:'Mensajes',data:ah.map(h=>hm[h]?hm[h].messages:0),backgroundColor:'rgba(79,140,255,.6)',borderRadius:4,yAxisID:'y'},
        {label:'Revenue',data:ah.map(h=>hm[h]?hm[h].sales_net:0),borderColor:'rgba(52,211,153,1)',backgroundColor:'rgba(52,211,153,.1)',borderWidth:2,type:'line',fill:true,tension:.3,pointRadius:3,yAxisID:'y1'}
      ]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{labels:{color:'#9ca3af'}}},scales:{x:{grid:{color:'#1e2235'},ticks:{color:'#6b7280',font:{size:9}}},y:{grid:{color:'#1e2235'},ticks:{color:'#6b7280'}},y1:{position:'right',grid:{display:false},ticks:{color:'#34d399',callback:v=>'$'+v}}}}});
    }
    cc('cChatResp_'+mid,{type:'doughnut',data:{labels:['< 2min','2-5min','5-10min','> 10min'],datasets:[{data:[tb.under_2m,tb.btwn_2_5m,tb.btwn_5_10m,tb.over_10m],backgroundColor:['rgba(52,211,153,.8)','rgba(79,140,255,.8)','rgba(251,191,36,.8)','rgba(248,113,113,.8)'],borderColor:'transparent'}]},options:{responsive:true,maintainAspectRatio:false,cutout:'60%',plugins:{legend:{position:'bottom',labels:{color:'#9ca3af',padding:10,font:{size:11}}}}}});
  },100);
}

function closeModal() { $('modalOverlay').classList.remove('active'); document.body.style.overflow=''; }

// =============== NAV & TABLE UTILS ===============
function switchTab(name, btn) {
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.dropdown-btn').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.dropdown').forEach(d=>d.classList.remove('open'));
  $('tab-'+name).classList.add('active');
  if(name.startsWith('turno')) {
    document.querySelector('.dropdown-btn').classList.add('active');
  } else if(btn) {
    btn.classList.add('active');
  }
}

function toggleDropdown(e) {
  e.stopPropagation();
  const dd = e.target.closest('.dropdown');
  dd.classList.toggle('open');
}
document.addEventListener('click',(e)=>{
  if(!e.target.closest('.dropdown'))document.querySelectorAll('.dropdown').forEach(d=>d.classList.remove('open'));
  if(!e.target.closest('.filter-dropdown')){closeDatePanel();closeModelPanel();}
});

function filterTbl(id, q) {
  const rows=$(id).querySelectorAll('tbody tr');
  const ql=q.toLowerCase();
  rows.forEach(r=>{r.style.display=r.textContent.toLowerCase().includes(ql)?'':'none';});
}

const ss={};
function sortTbl(id, col, type) {
  const tbl=$(id), tbody=tbl.querySelector('tbody'), rows=Array.from(tbody.querySelectorAll('tr'));
  const k=id+'_'+col; const asc=ss[k]=!ss[k];
  tbl.querySelectorAll('th').forEach(t=>t.classList.remove('sorted'));
  tbl.querySelectorAll('th')[col].classList.add('sorted');
  rows.sort((a,b)=>{
    const ca=a.cells[col],cb=b.cells[col];
    if(type==='n'){
      const va=ca.hasAttribute('data-sort')?parseFloat(ca.getAttribute('data-sort'))||0:parseFloat(ca.textContent.replace(/[$,%\s]/g,''))||0;
      const vb=cb.hasAttribute('data-sort')?parseFloat(cb.getAttribute('data-sort'))||0:parseFloat(cb.textContent.replace(/[$,%\s]/g,''))||0;
      return asc?va-vb:vb-va;
    }
    const va=ca.hasAttribute('data-sort')?ca.getAttribute('data-sort'):ca.textContent.trim();
    const vb=cb.hasAttribute('data-sort')?cb.getAttribute('data-sort'):cb.textContent.trim();
    return asc?va.localeCompare(vb):vb.localeCompare(va);
  });
  rows.forEach(r=>tbody.appendChild(r));
}

document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal();});
loadData();
</script>
</body>
</html>
